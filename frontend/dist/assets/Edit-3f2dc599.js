import{_ as fe,h as me,i as ge,j as pe,k as ce,m as _e,n as ye,d as we,o as Pe,f as be}from"./_plugin-vue_export-helper-5f0f1ec2.js";import{r as f,v as L,c as Ie,o as ke,E as r,q as Ce,a as y,b,d as j,e as d,h as z,j as E,f as t,w as a,g as u,t as G,x as W}from"./index-65be5f2e.js";const Fe={class:"container"},xe={class:"section"},Ve={class:"flex-row"},$e={key:1,class:"edit-section"},Se={class:"tool-bar flex-row space-between mb-20"},Te={class:"segment-list"},Ee={class:"pagination mt-20 text-right"},De={key:2,class:"error-section mt-20"},Ue={class:"dialog-footer"},Be={class:"dialog-footer"},ze={class:"dialog-footer"},Ge={class:"export-progress"},Re={class:"progress-info"},qe={class:"dialog-footer"},Me={__name:"Edit",setup(Ne){const m=f({srcFile:""}),F=f({segment:""}),x=f({file:""}),I=f({segment:""}),D=f({dstFile:""}),V=f([]),R=f(0),q=f(1),U=f(20),$=f(!1),S=f(!1),n=L({add:!1,import:!1,edit:!1,generate:!1}),v=L({list:!1,add:!1,import:!1,edit:!1,save:!1,generate:!1}),c=f(""),g=f(!1),o=f({}),w=f(""),p=f(null),h=Ie(()=>{if(!o.value.status)return"准备中";switch(o.value.status){case"pending":return"等待处理";case"processing":return"正在生成XDB";case"completed":return"生成完成";case"failed":return"生成失败: "+(o.value.errorMessage||"未知错误");default:return o.value.status}}),H=()=>!o.value.durationSeconds&&o.value.durationSeconds!==0?"0秒":`${o.value.durationSeconds}秒`;ke(async()=>{try{const l=await me();console.log("获取当前编辑文件信息:",l),l.data&&l.data.fileLoaded&&l.data.currentEditFile?(m.value.srcFile=l.data.currentEditFile,r.info(`已恢复编辑文件: ${l.data.currentEditFile}`),await k()):console.log("当前没有加载的编辑文件")}catch(l){console.error("获取当前编辑文件信息失败:",l)}});const J=l=>{p.value&&(clearInterval(p.value),p.value=null),console.log("开始轮询生成任务状态，任务ID:",l),X(l),p.value=setInterval(()=>{X(l)},1e3)},X=async l=>{try{const e=await be(l);if(console.log("获取生成任务状态成功:",e.data),!e.data){console.error("任务数据为空");return}o.value=e.data,(o.value.status==="completed"||o.value.status==="failed")&&(p.value&&(clearInterval(p.value),p.value=null),o.value.status==="completed"?(r.success(`XDB文件生成成功：${o.value.dstFile}`),g.value=!1,v.generate=!1,n.generate=!1):o.value.status==="failed"&&(r.error(`生成失败：${o.value.errorMessage||"未知错误"}`),g.value=!1,v.generate=!1))}catch(e){console.error("获取生成任务状态失败",e),o.value.retryCount?o.value.retryCount++:o.value.retryCount=1,o.value.retryCount>5&&(p.value&&(clearInterval(p.value),p.value=null),r.error("获取任务状态失败，请检查网络连接"),g.value=!1,v.generate=!1)}},K=async()=>{if(w.value)try{await pe(w.value),r.warning("生成任务已取消"),await X(w.value)}catch(l){r.error(l.message||"取消任务失败")}},k=async()=>{if(!m.value.srcFile){c.value="请输入源文件路径",r.warning("请先输入源文件路径");return}v.list=!0,c.value="";try{const l=await ge(m.value.srcFile,(q.value-1)*U.value,U.value);V.value=l.data.segments.map(e=>{const P=T(e.StartIP),_=T(e.EndIP),i=e.Region;return{segment:`${P}|${_}|${i}`,rawData:e}}),R.value=l.data.total,$.value=!0,S.value=!1,V.value.length>0?r.success(`成功加载 ${V.value.length} 条IP段记录，共 ${R.value} 条`):r.info("文件已加载，但没有找到IP段记录")}catch(l){c.value=l.message||"加载数据失败",r.error(`加载IP段失败: ${l.message||"未知错误"}`),console.error("加载IP段失败:",l)}finally{v.list=!1}},T=l=>{if(typeof l!="number")return"无效IP";const e=l>>24&255,P=l>>16&255,_=l>>8&255,i=l&255;return`${e}.${P}.${_}.${i}`},O=l=>{if(!l)return"";if(typeof l=="string")return l;const e=l.startIP||T(l.StartIP),P=l.endIP||T(l.EndIP),_=l.region||l.Region;return`${e}|${P}|${_}`},Q=()=>{k()},Y=()=>{k()},Z=async()=>{if(!F.value.segment){r.warning("请输入IP段");return}v.add=!0,c.value="";try{const l=await ce(F.value.segment,m.value.srcFile);r.success("添加成功"),n.add=!1,F.value.segment="",S.value=!0,await k()}catch(l){c.value=l.message||"添加IP段失败"}finally{v.add=!1}},ee=async l=>{try{await W.confirm("确定要删除该IP段吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),V.value.splice(l,1),S.value=!0,r.success("已标记删除，点击保存按钮生效")}catch{}},le=async()=>{if(!x.value.file){r.warning("请输入文件路径");return}v.import=!0,c.value="";try{const l=await _e(x.value.file,m.value.srcFile);r.success(`导入成功，删除了${l.data.oldCount}条，添加了${l.data.newCount}条`),n.import=!1,x.value.file="",S.value=!0,await k()}catch(l){c.value=l.message||"从文件导入失败"}finally{v.import=!1}},te=async()=>{if(!I.value.segment){r.warning("请输入IP段");return}v.edit=!0,c.value="";try{const l=await ye(I.value.segment,m.value.srcFile);r.success("编辑成功"),n.edit=!1,I.value.segment="",S.value=!0,await k()}catch(l){c.value=l.message||"编辑IP段失败"}finally{v.edit=!1}},ae=async()=>{if(!m.value.srcFile){r.warning("请先编辑一个文件");return}if(!D.value.dstFile){r.warning("请输入目标文件路径");return}v.generate=!0,g.value=!1,o.value={},w.value="";try{const l=await we(m.value.srcFile,D.value.dstFile);w.value=l.data.taskId,g.value=!0,o.value={status:"pending",startTime:new Date().getTime()},J(w.value),r.info("生成任务已创建，正在处理中...")}catch(l){r.error(l.message||"保存并生成数据库失败"),v.generate=!1,g.value=!1,o.value={},w.value=""}},A=l=>{I.value.segment=O(l.rawData),n.edit=!0},se=f(null),ne=l=>{A(l)},oe=()=>{g.value=!1,o.value={},w.value=""},re=async()=>{if(!m.value.srcFile){r.warning("当前没有加载的文件");return}try{await W.confirm("确定要卸载当前编辑的文件吗？所有未保存的更改将会丢失。","确认卸载",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const l=m.value.srcFile,e=await Pe();console.log("卸载文件响应:",e),V.value=[],R.value=0,q.value=1,U.value=20,$.value=!1,S.value=!1,n.add=!1,n.import=!1,n.edit=!1,n.generate=!1,m.value.srcFile="",c.value="",g.value=!1,o.value={},w.value="",r.success(`文件 ${l} 已成功卸载`)}catch(l){l.message!=="cancel"&&(console.error("卸载文件失败:",l),r.error(l.message||"卸载文件失败"))}};return Ce(()=>{p.value&&(clearInterval(p.value),p.value=null)}),(l,e)=>{const P=y("el-alert"),_=y("el-input"),i=y("el-button"),C=y("el-form-item"),B=y("el-form"),ue=y("el-divider"),M=y("el-table-column"),ie=y("el-table"),de=y("el-pagination"),N=y("el-dialog");return b(),j("div",Fe,[d("div",xe,[e[40]||(e[40]=d("h2",{class:"section-title"},"编辑数据",-1)),$.value?(b(),z(P,{key:0,type:"info",title:`当前加载的源文件: ${m.value.srcFile}`,closable:!1,"show-icon":"",class:"mb-20"},null,8,["title"])):E("",!0),t(B,{model:m.value,"label-width":"100px"},{default:a(()=>[t(C,{label:"源文件路径",required:""},{default:a(()=>[d("div",Ve,[t(_,{modelValue:m.value.srcFile,"onUpdate:modelValue":e[0]||(e[0]=s=>m.value.srcFile=s),placeholder:"请输入源文件路径，如：data/ip.merge.txt"},null,8,["modelValue"]),t(i,{type:"primary",class:"ml-10",onClick:k,loading:v.list},{default:a(()=>e[19]||(e[19]=[u(" 加载数据 ")])),_:1,__:[19]},8,["loading"]),$.value?(b(),z(i,{key:0,type:"danger",class:"ml-10",onClick:re},{default:a(()=>e[20]||(e[20]=[u(" 卸载文件 ")])),_:1,__:[20]})):E("",!0)])]),_:1})]),_:1},8,["model"]),t(ue),$.value?(b(),j("div",$e,[d("div",Se,[d("div",null,[t(i,{type:"primary",onClick:e[1]||(e[1]=s=>n.add=!0)},{default:a(()=>e[21]||(e[21]=[u("添加IP段")])),_:1,__:[21]}),t(i,{type:"primary",onClick:e[2]||(e[2]=s=>n.import=!0)},{default:a(()=>e[22]||(e[22]=[u("从文件导入")])),_:1,__:[22]}),t(i,{type:"primary",onClick:e[3]||(e[3]=s=>n.edit=!0)},{default:a(()=>e[23]||(e[23]=[u("编辑IP段(PUT)")])),_:1,__:[23]})]),d("div",null,[t(i,{type:"success",onClick:e[4]||(e[4]=s=>n.generate=!0),disabled:!$.value},{default:a(()=>e[24]||(e[24]=[u(" 保存并生成XDB ")])),_:1,__:[24]},8,["disabled"])])]),d("div",Te,[t(ie,{ref_key:"tableRef",ref:se,data:V.value,style:{width:"100%"},border:"","max-height":"500",onRowClick:ne,"highlight-current-row":""},{default:a(()=>[t(M,{label:"起始IP",width:"140"},{default:a(s=>[u(G(T(s.row.rawData.StartIP)),1)]),_:1}),t(M,{label:"结束IP",width:"140"},{default:a(s=>[u(G(T(s.row.rawData.EndIP)),1)]),_:1}),t(M,{label:"区域信息","min-width":"200"},{default:a(s=>[u(G(s.row.rawData.Region),1)]),_:1}),t(M,{label:"操作",width:"180"},{default:a(s=>[t(i,{type:"primary",size:"small",onClick:ve=>A(s.row),style:{"margin-right":"5px"}},{default:a(()=>e[25]||(e[25]=[u(" 编辑 ")])),_:2,__:[25]},1032,["onClick"]),t(i,{type:"danger",size:"small",onClick:ve=>ee(s.$index)},{default:a(()=>e[26]||(e[26]=[u(" 删除 ")])),_:2,__:[26]},1032,["onClick"])]),_:1})]),_:1},8,["data"]),d("div",Ee,[t(de,{"current-page":q.value,"onUpdate:currentPage":e[5]||(e[5]=s=>q.value=s),"page-size":U.value,"onUpdate:pageSize":e[6]||(e[6]=s=>U.value=s),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:R.value,onSizeChange:Q,onCurrentChange:Y},null,8,["current-page","page-size","total"])])])])):E("",!0),c.value?(b(),j("div",De,[t(P,{title:c.value,type:"error","show-icon":"",closable:!1},null,8,["title"])])):E("",!0),t(N,{modelValue:n.add,"onUpdate:modelValue":e[9]||(e[9]=s=>n.add=s),title:"添加IP段",width:"500px"},{footer:a(()=>[d("span",Ue,[t(i,{onClick:e[8]||(e[8]=s=>n.add=!1)},{default:a(()=>e[28]||(e[28]=[u("取 消")])),_:1,__:[28]}),t(i,{type:"primary",onClick:Z,loading:v.add},{default:a(()=>e[29]||(e[29]=[u(" 确 定 ")])),_:1,__:[29]},8,["loading"])])]),default:a(()=>[t(B,{model:F.value,"label-width":"100px"},{default:a(()=>[t(C,{label:"IP段",required:""},{default:a(()=>[t(_,{modelValue:F.value.segment,"onUpdate:modelValue":e[7]||(e[7]=s=>F.value.segment=s),placeholder:"格式：startIP|endIP|国家|区域|省份|城市|ISP"},null,8,["modelValue"]),e[27]||(e[27]=d("div",{class:"form-item-help"},"例如：36.132.128.0|36.132.147.255|中国|0|黑龙江省|哈尔滨市|移动",-1))]),_:1,__:[27]})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(N,{modelValue:n.import,"onUpdate:modelValue":e[12]||(e[12]=s=>n.import=s),title:"从文件导入",width:"500px"},{footer:a(()=>[d("span",Be,[t(i,{onClick:e[11]||(e[11]=s=>n.import=!1)},{default:a(()=>e[30]||(e[30]=[u("取 消")])),_:1,__:[30]}),t(i,{type:"primary",onClick:le,loading:v.import},{default:a(()=>e[31]||(e[31]=[u(" 确 定 ")])),_:1,__:[31]},8,["loading"])])]),default:a(()=>[t(B,{model:x.value,"label-width":"100px"},{default:a(()=>[t(C,{label:"文件路径",required:""},{default:a(()=>[t(_,{modelValue:x.value.file,"onUpdate:modelValue":e[10]||(e[10]=s=>x.value.file=s),placeholder:"请输入文件路径"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(N,{modelValue:n.edit,"onUpdate:modelValue":e[15]||(e[15]=s=>n.edit=s),title:"编辑IP段 (PUT方式)",width:"500px"},{footer:a(()=>[d("span",ze,[t(i,{onClick:e[14]||(e[14]=s=>n.edit=!1)},{default:a(()=>e[33]||(e[33]=[u("取 消")])),_:1,__:[33]}),t(i,{type:"primary",onClick:te,loading:v.edit},{default:a(()=>e[34]||(e[34]=[u(" 确 定 ")])),_:1,__:[34]},8,["loading"])])]),default:a(()=>[t(B,{model:I.value,"label-width":"100px"},{default:a(()=>[t(C,{label:"IP段",required:""},{default:a(()=>[t(_,{modelValue:I.value.segment,"onUpdate:modelValue":e[13]||(e[13]=s=>I.value.segment=s),placeholder:"格式：startIP|endIP|国家|区域|省份|城市|ISP"},null,8,["modelValue"]),e[32]||(e[32]=d("div",{class:"form-item-help"},"例如：36.132.128.0|36.132.147.255|中国|0|黑龙江省|哈尔滨市|移动",-1))]),_:1,__:[32]})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(N,{modelValue:n.generate,"onUpdate:modelValue":e[18]||(e[18]=s=>n.generate=s),title:"保存并生成XDB文件",width:"500px","close-on-click-modal":!1,"close-on-press-escape":!g.value,"show-close":!g.value,onClosed:oe},{footer:a(()=>[d("div",qe,[t(i,{onClick:e[17]||(e[17]=s=>n.generate=!1),disabled:g.value},{default:a(()=>e[37]||(e[37]=[u(" 取 消 ")])),_:1,__:[37]},8,["disabled"]),g.value?o.value.status!=="completed"&&o.value.status!=="failed"?(b(),z(i,{key:1,type:"danger",onClick:K},{default:a(()=>e[39]||(e[39]=[u(" 取消生成 ")])),_:1,__:[39]})):E("",!0):(b(),z(i,{key:0,type:"primary",onClick:ae,loading:v.generate},{default:a(()=>e[38]||(e[38]=[u(" 确 定 ")])),_:1,__:[38]},8,["loading"]))])]),default:a(()=>[t(B,{model:D.value,"label-width":"100px"},{default:a(()=>[t(C,{label:"目标文件",required:""},{default:a(()=>[t(_,{modelValue:D.value.dstFile,"onUpdate:modelValue":e[16]||(e[16]=s=>D.value.dstFile=s),placeholder:"请输入目标文件路径，如：data/ip2region.xdb",disabled:g.value},null,8,["modelValue","disabled"])]),_:1}),g.value?(b(),z(C,{key:0},{default:a(()=>[d("div",Ge,[d("div",Re,[d("p",null,[e[35]||(e[35]=d("strong",null,"当前状态:",-1)),u(" "+G(h.value),1)]),d("p",null,[e[36]||(e[36]=d("strong",null,"已运行时间:",-1)),u(" "+G(H()),1)])])])]),_:1})):E("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","close-on-press-escape","show-close"])])])}}},Ae=fe(Me,[["__scopeId","data-v-9c84f6f0"]]);export{Ae as default};
