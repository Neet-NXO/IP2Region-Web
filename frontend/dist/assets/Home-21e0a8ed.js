import{u as ne,r as i,c as re,o as ue,a as d,b as c,d as O,e as t,f as a,w as o,g as n,h as k,i as I,j as F,t as _,E as u,k as de,s as ie,l as ve,m as pe}from"./index-65be5f2e.js";import{_ as fe,g as j,l as me,u as ge,c as ce,e as _e,a as xe}from"./_plugin-vue_export-helper-5f0f1ec2.js";const ye={class:"container"},be={class:"section"},we={class:"load-xdb-section"},ke={class:"xdb-loader"},Pe={class:"xdb-tip"},Te={class:"export-progress"},Ie={class:"progress-info"},De={class:"dialog-footer"},Be={key:0,class:"load-result"},Ce={class:"result-details"},Se={class:"feature-section"},Xe={__name:"Home",setup(Ve){const E=ne(),D=i("./ip2region.xdb"),X=i("vector"),M=i(!1),z=i(!1),p=i(null),b=i(!1),B=i(""),C=i(!1),P=i(!1),g=i({xdbPath:"",exportPath:"ip2region.xdb.export.txt"}),f=i(!1),s=i({}),w=i(""),r=i(null),A=re(()=>{if(!s.value.status)return"准备中";let l="";switch(s.value.status){case"pending":l="等待处理";break;case"processing":l=s.value.detailedStatus||"正在导出";break;case"completed":l="导出完成";break;case"failed":l="导出失败: "+(s.value.errorMessage||"未知错误");break;default:l=s.value.status}return s.value.status==="processing"&&s.value.detailedStatus?s.value.detailedStatus:l});ue(async()=>{try{const l=await j();l.data&&l.data.loaded&&(p.value=l.data.status,b.value=!0,D.value=l.data.status.dbPath)}catch(l){console.error("获取XDB状态失败",l)}});const G=async()=>{if(!D.value){u.warning("请输入XDB文件路径");return}M.value=!0,p.value=null,b.value=!1,B.value="";try{const l=await me(D.value,X.value);p.value=l.data,b.value=!0,u.success(`数据库加载成功 - ${L(X.value)}`)}catch(l){B.value=l.message||"加载失败，请检查文件路径是否正确",l.message&&l.message.includes("文件大小不足")&&(B.value=`${l.message}。请下载完整的XDB文件或使用"生成数据库"功能创建新的XDB文件。`),u.error(B.value)}finally{M.value=!1}},L=l=>{switch(l){case"file":return"文件模式";case"vector":return"向量模式";case"memory":return"内存模式";default:return"未知模式"}},W=async()=>{if(!b.value){u.warning("当前没有加载的XDB文件");return}z.value=!0;try{await ge(),p.value=null,b.value=!1,u.success("XDB文件已从内存中卸载，现在可以安全地删除或修改文件"),setTimeout(async()=>{try{const l=await j();l.data&&l.data.loaded&&u.warning("文件卸载可能未完全成功，请稍后再试")}catch(l){console.error("检查卸载状态失败",l)}},1e3)}catch(l){u.error(l.message||"卸载失败")}finally{z.value=!1}},q=()=>{g.value.xdbPath=D.value,C.value=!0,f.value=!1,s.value={},w.value="",r.value&&(clearInterval(r.value),r.value=null)},Q=()=>{if(f.value){r.value&&(clearInterval(r.value),r.value=null),C.value=!1;return}C.value=!1},Y=l=>{r.value&&(clearInterval(r.value),r.value=null),console.log("开始轮询任务状态，任务ID:",l),R(l),r.value=setInterval(()=>{R(l)},2e3)},R=async l=>{console.log("正在查询任务状态:",l);const e=new Date().getTime();if(s.value.startTime,K()>900){r.value&&(clearInterval(r.value),r.value=null),u.error("导出任务执行时间过长，可能存在问题。建议取消并重试。");return}try{const m=await xe(l);if(console.log("获取任务状态成功:",m.data),!m.data){console.error("任务数据为空");return}s.value=m.data,console.log("Updated exportTask in getExportTaskStatus:",JSON.parse(JSON.stringify(s.value))),(s.value.status==="completed"||s.value.status==="failed")&&(r.value&&(clearInterval(r.value),r.value=null),s.value.status==="completed"?(u.success(`导出成功：${s.value.segmentCount} 个IP段`),P.value=!1):s.value.status==="failed"&&(u.error(`导出失败：${s.value.errorMessage||"未知错误"}`),P.value=!1))}catch(m){console.error("获取导出任务状态失败",m),m.response&&console.error("错误响应:",m.response),s.value.retryCount?s.value.retryCount++:s.value.retryCount=1,s.value.retryCount>5&&(r.value&&(clearInterval(r.value),r.value=null),u.error("获取任务状态失败，请检查网络连接"),P.value=!1)}},Z=async()=>{if(w.value)try{await ce(w.value),u.warning("导出任务已取消"),await R(w.value)}catch(l){u.error(l.message||"取消任务失败")}},h=async()=>{if(!g.value.xdbPath||!g.value.exportPath){u.warning("请填写完整的导出信息");return}if(f.value){u.warning("已有导出任务正在进行，请等待完成或取消当前任务");return}P.value=!0,f.value=!1,s.value={},w.value="";try{console.log("开始创建导出任务:",g.value);const l=await _e(g.value.xdbPath,g.value.exportPath);if(console.log("导出任务创建成功:",l.data),!l.data||!l.data.taskId)throw new Error("服务器未返回任务ID");w.value=l.data.taskId,f.value=!0,s.value={status:"pending",startTime:new Date().getTime(),progress:0,recordCount:0,segmentCount:0},Y(w.value),u.info(`导出任务已创建(ID:${w.value})，正在处理中...`)}catch(l){console.error("创建导出任务失败",l),u.error(l.message||"创建导出任务失败"),P.value=!1}},K=()=>{if(!s.value.startTime)return 0;if(s.value.durationSeconds!==void 0)return s.value.durationSeconds;let l=0;if(typeof s.value.startTime=="string")l=new Date(s.value.startTime).getTime();else if(typeof s.value.startTime=="number")l=s.value.startTime;else return 0;const e=new Date().getTime();if(isNaN(l)||l<=0||e<l)return 0;const x=Math.floor((e-l)/1e3);return x>=0?x:0},ee=()=>`${K()}秒`,le=l=>{if(typeof l!="number"||l===0)return"0.0.0.0";const e=l>>>24&255,x=l>>>16&255,m=l>>>8&255,S=l&255;return`${e}.${x}.${m}.${S}`};return(l,e)=>{const x=d("el-divider"),m=d("el-tag"),S=d("el-input"),T=d("el-form-item"),H=d("el-radio"),te=d("el-radio-group"),y=d("el-button"),V=d("el-icon"),N=d("el-form"),ae=d("el-progress"),oe=d("el-dialog"),J=d("el-alert"),$=d("el-card"),U=d("el-col"),se=d("el-row");return c(),O("div",ye,[t("div",be,[e[39]||(e[39]=t("h1",{class:"text-center"},"欢迎使用 IP2Region Web",-1)),e[40]||(e[40]=t("p",{class:"text-center"},"高效的IP地址查询和管理工具",-1)),a(x),t("div",we,[a($,{shadow:"hover"},{default:o(()=>[t("div",ke,[e[27]||(e[27]=t("h3",null,"XDB文件加载",-1)),e[28]||(e[28]=t("p",null,"选择合适的加载模式来优化IP查询性能。",-1)),t("p",Pe,[a(m,{type:"info",effect:"plain"},{default:o(()=>e[8]||(e[8]=[n("提示")])),_:1,__:[8]}),e[9]||(e[9]=n(" 请确保XDB文件有效且完整，文件大小通常为几MB。如果遇到加载错误，可能是文件不完整或格式错误。 "))]),a(N,null,{default:o(()=>[a(T,{label:"数据库文件"},{default:o(()=>[a(S,{modelValue:D.value,"onUpdate:modelValue":e[0]||(e[0]=v=>D.value=v),placeholder:"请输入XDB文件路径，例如：./ip2region.xdb",clearable:""},null,8,["modelValue"])]),_:1}),a(T,{label:"加载模式"},{default:o(()=>[a(te,{modelValue:X.value,"onUpdate:modelValue":e[1]||(e[1]=v=>X.value=v)},{default:o(()=>[a(H,{value:"vector"},{default:o(()=>e[10]||(e[10]=[t("div",{class:"mode-option"},[t("div",{class:"mode-name"},"向量模式"),t("div",{class:"mode-desc"},"缓存向量索引到内存，平衡内存占用和查询性能（推荐）")],-1)])),_:1,__:[10]}),a(H,{value:"memory"},{default:o(()=>e[11]||(e[11]=[t("div",{class:"mode-option"},[t("div",{class:"mode-name"},"内存模式"),t("div",{class:"mode-desc"},"将整个XDB文件加载到内存，查询性能最佳")],-1)])),_:1,__:[11]})]),_:1},8,["modelValue"])]),_:1}),a(T,null,{default:o(()=>[b.value?(c(),k(y,{key:1,onClick:W,loading:z.value,type:"danger",size:"large"},{default:o(()=>e[13]||(e[13]=[n(" 卸载数据库 ")])),_:1,__:[13]},8,["loading"])):(c(),k(y,{key:0,onClick:G,loading:M.value,type:"primary",size:"large"},{default:o(()=>e[12]||(e[12]=[n(" 加载数据库 ")])),_:1,__:[12]},8,["loading"]))]),_:1}),b.value?(c(),k(T,{key:0},{default:o(()=>[a(y,{type:"success",onClick:q,loading:P.value},{default:o(()=>[a(V,null,{default:o(()=>[a(I(de))]),_:1}),e[14]||(e[14]=n(" 导出XDB "))]),_:1,__:[14]},8,["loading"]),e[15]||(e[15]=t("span",{class:"export-tip"},"导出XDB文件内容到文本文件",-1))]),_:1,__:[15]})):F("",!0)]),_:1}),a(oe,{modelValue:C.value,"onUpdate:modelValue":e[4]||(e[4]=v=>C.value=v),title:"导出XDB文件",width:"500px","close-on-click-modal":!1,"close-on-press-escape":!f.value,"show-close":!f.value},{footer:o(()=>[t("div",De,[a(y,{onClick:Q},{default:o(()=>[n(_(f.value?"关闭":"取消"),1)]),_:1}),f.value?s.value.status!=="completed"&&s.value.status!=="failed"?(c(),k(y,{key:1,type:"danger",onClick:Z},{default:o(()=>e[21]||(e[21]=[n(" 取消导出 ")])),_:1,__:[21]})):F("",!0):(c(),k(y,{key:0,type:"primary",onClick:h,loading:P.value},{default:o(()=>e[20]||(e[20]=[n(" 导出 ")])),_:1,__:[20]},8,["loading"]))])]),default:o(()=>[a(N,null,{default:o(()=>[a(T,{label:"XDB文件路径"},{default:o(()=>[a(S,{modelValue:g.value.xdbPath,"onUpdate:modelValue":e[2]||(e[2]=v=>g.value.xdbPath=v),disabled:""},null,8,["modelValue"])]),_:1}),a(T,{label:"导出文件路径"},{default:o(()=>[a(S,{modelValue:g.value.exportPath,"onUpdate:modelValue":e[3]||(e[3]=v=>g.value.exportPath=v),placeholder:"请输入导出文件路径，例如：ip2region.xdb.export.txt",disabled:f.value},null,8,["modelValue","disabled"])]),_:1}),f.value?(c(),k(T,{key:0},{default:o(()=>[t("div",Te,[t("div",Ie,[t("p",null,[e[16]||(e[16]=t("strong",null,"状态:",-1)),n(" "+_(A.value),1)]),t("p",null,[e[17]||(e[17]=t("strong",null,"已发现IP段:",-1)),n(" "+_(s.value.segmentCount||0),1)]),t("p",null,[e[18]||(e[18]=t("strong",null,"当前处理IP:",-1)),n(" "+_(le(s.value.recordCount||0)),1)]),a(ae,{percentage:s.value.progress||0,"stroke-width":10,striped:""},null,8,["percentage"]),t("p",null,[e[19]||(e[19]=t("strong",null,"已运行时间:",-1)),n(" "+_(ee()),1)])])])]),_:1})):F("",!0)]),_:1})]),_:1},8,["modelValue","close-on-press-escape","show-close"]),p.value?(c(),O("div",Be,[b.value?(c(),k(J,{key:0,type:"success",title:`XDB文件加载成功: ${p.value.dbPath}`,"show-icon":""},{default:o(()=>[t("div",Ce,[t("p",null,[e[22]||(e[22]=t("strong",null,"内存模式:",-1)),n(" "+_(p.value.inMemoryMode?"是":"否"),1)]),t("p",null,[e[23]||(e[23]=t("strong",null,"缓冲区大小:",-1)),n(" "+_(p.value.bufferSizeKB)+" KB",1)]),t("p",null,[e[24]||(e[24]=t("strong",null,"向量索引已加载:",-1)),n(" "+_(p.value.vectorLoaded?"是":"否"),1)]),t("p",null,[e[25]||(e[25]=t("strong",null,"向量索引大小:",-1)),n(" "+_(p.value.vectorSizeKB)+" KB",1)]),t("p",null,[e[26]||(e[26]=t("strong",null,"加载耗时:",-1)),n(" "+_(p.value.loadTimeTaken),1)])])]),_:1},8,["title"])):(c(),k(J,{key:1,type:"error",title:B.value,"show-icon":""},null,8,["title"]))])):F("",!0)])]),_:1})]),a(x),t("div",Se,[e[38]||(e[38]=t("h2",null,"核心功能",-1)),a(se,{gutter:20},{default:o(()=>[a(U,{span:8},{default:o(()=>[a($,{shadow:"hover",class:"feature-card"},{default:o(()=>[a(V,{size:"30",color:"#409EFF"},{default:o(()=>[a(I(ie))]),_:1}),e[30]||(e[30]=t("h3",null,"IP地址查询",-1)),e[31]||(e[31]=t("p",null,"快速查询IP地址的地理位置信息，支持国家、地区、省份、城市和ISP信息。",-1)),a(y,{type:"primary",onClick:e[5]||(e[5]=v=>I(E).push("/search"))},{default:o(()=>e[29]||(e[29]=[n("开始查询")])),_:1,__:[29]})]),_:1,__:[30,31]})]),_:1}),a(U,{span:8},{default:o(()=>[a($,{shadow:"hover",class:"feature-card"},{default:o(()=>[a(V,{size:"30",color:"#409EFF"},{default:o(()=>[a(I(ve))]),_:1}),e[33]||(e[33]=t("h3",null,"生成数据库",-1)),e[34]||(e[34]=t("p",null,"将文本格式的IP段数据转换为高效的二进制索引文件，实现快速查询。",-1)),a(y,{type:"primary",onClick:e[6]||(e[6]=v=>I(E).push("/generate"))},{default:o(()=>e[32]||(e[32]=[n("数据库生成")])),_:1,__:[32]})]),_:1,__:[33,34]})]),_:1}),a(U,{span:8},{default:o(()=>[a($,{shadow:"hover",class:"feature-card"},{default:o(()=>[a(V,{size:"30",color:"#409EFF"},{default:o(()=>[a(I(pe))]),_:1}),e[36]||(e[36]=t("h3",null,"数据编辑",-1)),e[37]||(e[37]=t("p",null,"提供IP段数据的编辑功能，支持单条编辑和批量导入，方便维护IP数据。",-1)),a(y,{type:"primary",onClick:e[7]||(e[7]=v=>I(E).push("/edit"))},{default:o(()=>e[35]||(e[35]=[n("编辑数据")])),_:1,__:[35]})]),_:1,__:[36,37]})]),_:1})]),_:1})]),a(x),e[41]||(e[41]=t("div",{class:"about-section"},[t("h2",null,"关于 IP2Region"),t("p",null,"IP2Region是一个离线IP地址定位库和IP定位服务，支持亿级别的数据量，响应时间在毫秒级别。提供了众多主流编程语言的SDK实现，包括：C、C++、Java、PHP、Python、Node、Go等。可广泛应用于大数据分析、物联网、网络安全等领域。")],-1))])])}}},Ee=fe(Xe,[["__scopeId","data-v-eea4353f"]]);export{Ee as default};
